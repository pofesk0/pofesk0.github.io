<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Android Launcher Icon Generator</title>

<style>
body {
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 12px;
  font-family: sans-serif;
}
</style>
</head>
<body>

<input type="file" id="file" accept="image/*">
<button onclick="gen()">Generate ZIP</button>

<script>
/* ===== CRC32 ===== */
function crc32(buf) {
  let c = ~0;
  for (let i = 0; i < buf.length; i++) {
    c ^= buf[i];
    for (let k = 0; k < 8; k++)
      c = c & 1 ? (c >>> 1) ^ 0xEDB88320 : c >>> 1;
  }
  return ~c >>> 0;
}

/* ===== RAW ZIP (STORE) ===== */
function zip(files) {
  const chunks = [];
  const central = [];
  let offset = 0;

  const enc = s => new TextEncoder().encode(s);

  for (const f of files) {
    const name = enc(f.name);
    const data = f.data;
    const crc = crc32(data);

    const local = new Uint8Array(30);
    const view = new DataView(local.buffer);

    view.setUint32(0, 0x04034b50, true);
    view.setUint16(4, 20, true);
    view.setUint16(6, 0, true);
    view.setUint16(8, 0, true); // STORE
    view.setUint32(10, 0, true);
    view.setUint32(14, crc, true);
    view.setUint32(18, data.length, true);
    view.setUint32(22, data.length, true);
    view.setUint16(26, name.length, true);
    view.setUint16(28, 0, true);

    chunks.push(local, name, data);

    const centralHdr = new Uint8Array(46);
    const cview = new DataView(centralHdr.buffer);

    cview.setUint32(0, 0x02014b50, true);
    cview.setUint16(4, 20, true);
    cview.setUint16(6, 20, true);
    cview.setUint16(8, 0, true);
    cview.setUint16(10, 0, true);
    cview.setUint32(12, 0, true);
    cview.setUint32(16, crc, true);
    cview.setUint32(20, data.length, true);
    cview.setUint32(24, data.length, true);
    cview.setUint16(28, name.length, true);
    cview.setUint16(30, 0, true);
    cview.setUint16(32, 0, true);
    cview.setUint16(34, 0, true);
    cview.setUint32(38, 0, true);
    cview.setUint32(42, offset, true);

    central.push(centralHdr, name);

    offset += local.length + name.length + data.length;
  }

  const centralSize = central.reduce((s, a) => s + a.length, 0);

  const end = new Uint8Array(22);
  const eview = new DataView(end.buffer);

  eview.setUint32(0, 0x06054b50, true);
  eview.setUint16(8, files.length, true);
  eview.setUint16(10, files.length, true);
  eview.setUint32(12, centralSize, true);
  eview.setUint32(16, offset, true);

  return new Blob([...chunks, ...central, end], { type: 'application/zip' });
}

/* ===== ICON LOGIC ===== */
const sizes = {
  mdpi: 48,
  hdpi: 72,
  xhdpi: 96,
  xxhdpi: 144,
  xxxhdpi: 192
};

function drawFit(img, size) {
  const c = document.createElement('canvas');
  c.width = c.height = size;
  const ctx = c.getContext('2d');

  const scale = Math.min(size / img.width, size / img.height);
  const w = img.width * scale;
  const h = img.height * scale;
  ctx.drawImage(img, (size - w) / 2, (size - h) / 2, w, h);
  return c;
}

function gen() {
  const f = file.files[0];
  if (!f) return alert('Выбери файл');

  const reader = new FileReader();
  reader.onload = () => {
    const img = new Image();
    img.onload = async () => {
      const files = [];

      for (const d in sizes) {
        const c = drawFit(img, sizes[d]);
        const buf = await new Promise(r =>
          c.toBlob(b => b.arrayBuffer().then(r), 'image/png')
        );

        files.push({
          name: `drawable-${d}/ic_launcher.png`,
          data: new Uint8Array(buf)
        });
      }

      const z = zip(files);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(z);
      a.download = 'android_launcher_icons.zip';
      a.click();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(f);
}
</script>

</body>
</html>